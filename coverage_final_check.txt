
> projeto-nextjs@0.1.0 test
> vitest --coverage --no-color

Loaded  vitest@4.0.16  and  @vitest/coverage-v8@4.0.15 .
Running mixed versions is not supported and may lead into bugs
Update your dependencies and make sure the versions match.

 DEV  v4.0.16 /home/jhontavares/Documents/Programacao/Journal-NextJs
      Coverage enabled with v8

stdout | src/lib/__tests__/production-smoke.test.ts
[dotenv@17.2.3] injecting env (6) from .env.local -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

stdout | src/lib/__tests__/production-smoke.test.ts > Production Performance Tests
‚úÖ Supabase client initialized for production tests

stdout | src/lib/__tests__/performance.test.ts > TradeRepository Performance > Query Performance Benchmarks > should fetch 100 trades with basic fragment in less than 500ms
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:31.111Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  options: { detailed: [33mfalse[39m, limit: [33m100[39m }
}

stdout | src/lib/__tests__/performance.test.ts > TradeRepository Performance > Query Performance Benchmarks > should fetch 100 trades with basic fragment in less than 500ms
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:31.166Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  count: [33m100[39m,
  durationMs: [33m54[39m
}

stdout | src/lib/__tests__/performance.test.ts > TradeRepository Performance > Query Performance Benchmarks > should fetch trades with pagination in less than 300ms
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:31.168Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  options: { detailed: [33mfalse[39m, limit: [33m10[39m, offset: [33m0[39m }
}

stdout | src/lib/__tests__/performance.test.ts > TradeRepository Performance > Query Performance Benchmarks > should fetch trades with pagination in less than 300ms
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:31.199Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  count: [33m50[39m,
  durationMs: [33m31[39m
}

stdout | src/lib/__tests__/performance.test.ts > TradeRepository Performance > Query Performance Benchmarks > should handle detailed fragments without significant performance degradation
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:31.200Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  options: { detailed: [33mfalse[39m }
}

stdout | src/lib/__tests__/performance.test.ts > TradeRepository Performance > Query Performance Benchmarks > should handle detailed fragments without significant performance degradation
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:31.250Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  count: [33m50[39m,
  durationMs: [33m50[39m
}

stdout | src/lib/__tests__/performance.test.ts > TradeRepository Performance > Query Performance Benchmarks > should handle detailed fragments without significant performance degradation
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:31.251Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  options: { detailed: [33mtrue[39m }
}

stdout | src/lib/__tests__/performance.test.ts > TradeRepository Performance > Query Performance Benchmarks > should handle detailed fragments without significant performance degradation
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:31.301Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  count: [33m50[39m,
  durationMs: [33m50[39m
}

stdout | src/lib/__tests__/performance.test.ts > TradeRepository Performance > Query Performance Benchmarks > should return results in acceptable time for getByIdDomain
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:25:31.302Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-1'[39m,
  withAuthCheck: [33mfalse[39m
}

 ‚úì src/lib/__tests__/performance.test.ts (4 tests) 216ms
 ‚úì src/__tests__/components/journal/form/LinkTradeModal.test.tsx (5 tests) 272ms
 ‚úì src/__tests__/components/ui/UIComponents.test.tsx (10 tests) 374ms
 ‚úì src/components/trades/__tests__/RiskRewardCards.test.tsx (8 tests) 81ms
Not implemented: Window's scrollTo() method
Not implemented: Window's scrollTo() method
 ‚úì src/__tests__/components/ui/WeekPicker.test.tsx (7 tests) 470ms
 ‚úì src/components/journal/__tests__/DayDetailModal.state.test.tsx (2 tests) 113ms
stdout | src/lib/__tests__/production-smoke.test.ts > Production Performance Tests > Query Performance > should query 100 trades in less than 2000ms
‚úÖ Query took 1108.09ms (0 trades)

 ‚úì src/components/trades/__tests__/ConfluenceTags.test.tsx (13 tests) 451ms
stdout | src/lib/__tests__/production-smoke.test.ts > Production Performance Tests > Query Performance > should query trades by date range efficiently
‚úÖ Date range query took 251.69ms (0 trades)

 ‚úì src/__tests__/components/journal/form/EntryHeader.test.tsx (4 tests) 59ms
 ‚úì src/components/trades/__tests__/TradeResultBadge.test.tsx (18 tests) 106ms
stderr | src/__tests__/components/journal/form/JournalEntryForm.test.tsx > JournalEntryForm > opens link trade modal
An update to JournalEntryForm inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://react.dev/link/wrap-tests-with-act

stdout | src/lib/__tests__/production-smoke.test.ts > Production Performance Tests > Query Performance > should query journal entries efficiently
‚úÖ Journal entries query took 250.15ms (6 entries)

 ‚úì src/__tests__/components/journal/form/JournalEntryForm.test.tsx (4 tests) 69ms
 ‚úì src/__tests__/components/journal/form/JournalAnalysis.test.tsx (3 tests) 71ms
stdout | src/lib/__tests__/production-smoke.test.ts > Production Performance Tests > Query Performance > should query junction table efficiently
‚úÖ Junction table query took 210.08ms (7 rows)

 ‚úì src/__tests__/components/journal/form/JournalReview.test.tsx (4 tests) 54ms
 ‚úì src/__tests__/components/journal/form/TradeLinker.test.tsx (4 tests) 78ms
stdout | src/lib/__tests__/production-smoke.test.ts > Production Performance Tests > Index Verification > should verify indexes exist via information_schema
‚úÖ Index verification query took 182.26ms

 ‚úì src/components/trades/__tests__/SelectValueWithIcon.test.tsx (8 tests) 78ms
stdout | src/lib/__tests__/production-smoke.test.ts > Production Performance Tests > Data Transfer Optimization > should return minimal data with specific select
‚ö†Ô∏è No trades found, skipping data transfer test

 ‚úì src/__tests__/hooks/useImageCache.test.ts (12 tests) 58ms
stdout | src/lib/__tests__/production-smoke.test.ts > Production Performance Tests > Concurrent Operations > should handle multiple concurrent queries
‚úÖ 5 concurrent queries took 232.64ms

 ‚úì src/lib/__tests__/production-smoke.test.ts (7 tests) 2582ms
       ‚úì should query 100 trades in less than 2000ms  1110ms
       ‚úì should return minimal data with specific select  325ms
 ‚úì src/components/trades/__tests__/useTradeValidation.test.ts (23 tests) 56ms
 ‚úì src/__tests__/lib/utils/imageCompression.test.ts (9 tests) 49ms
stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:33.855Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:33.860Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  count: [33m0[39m,
  durationMs: [33m6[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:33.864Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:33.864Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respect limit option
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:33.868Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: { limit: [33m5[39m }
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respect limit option
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:33.869Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respect offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:33.870Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: { limit: [33m10[39m, offset: [33m5[39m }
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respect offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:33.870Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return trade by ID without auth check
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:25:33.871Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mfalse[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return trade if userId matches
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:25:33.872Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:25:33.873Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:25:33.873Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user'[39m,
  ownerId: [32m'user-abc'[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:25:33.875Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:25:33.875Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:25:33.876Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:25:33.876Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:25:33.876Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  ownerId: [32m'user-abc'[39m
}

stderr | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:25:33.876Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  errorCode: [32m'AUTH_FORBIDDEN'[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:25:33.877Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:25:33.877Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:25:33.877Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m,
  errorCode: [32m'DB_NOT_FOUND'[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByAccountId > should return trades for account ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by account ID'[39m,
  timestamp: [32m'2025-12-19T21:25:33.878Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  accountId: [32m'account-xyz'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > getByAccountId > should use basic fragment by default
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by account ID'[39m,
  timestamp: [32m'2025-12-19T21:25:33.879Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  accountId: [32m'account-xyz'[39m,
  options: { detailed: [33mfalse[39m }
}

stdout | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:33.880Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stderr | src/lib/__tests__/unit/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to fetch trades by journal ID'[39m,
  timestamp: [32m'2025-12-19T21:25:33.880Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Database connection failed'[39m, code: [32m'CONNECTION_ERROR'[39m },
  journalId: [32m'journal-123'[39m
}

 ‚úì src/lib/__tests__/unit/TradeRepository.test.ts (13 tests) 28ms
 ‚úì src/__tests__/components/ui/LayoutComponents.test.tsx (12 tests) 99ms
 ‚úì src/__tests__/services/reportService.test.ts (1 test) 73ms
 ‚úì src/__tests__/hooks/useBlockBodyScroll.test.ts (3 tests) 43ms
 ‚úì src/__tests__/lib/calculations.test.ts (16 tests) 32ms
stderr | src/__tests__/services/mentor/inviteService.test.ts > MentorService > inviteMentee > should return null if not authenticated
[inviteMentee] No authenticated user

stderr | src/__tests__/services/mentor/inviteService.test.ts > MentorService > inviteMentee > should return null on supabase error
[inviteMentee] Error creating invite: { message: [32m'DB Error'[39m }

stderr | src/__tests__/services/mentor/inviteService.test.ts > MentorService > getSentInvites > should return empty array on error
[getSentInvites] Error: { message: [32m'Error'[39m }

stderr | src/__tests__/services/mentor/inviteService.test.ts > MentorService > acceptInvite > should return false on error
Erro ao aceitar convite: { message: [32m'Error'[39m }

stderr | src/__tests__/services/mentor/inviteService.test.ts > MentorService > rejectInvite > should return false on error
Erro ao rejeitar convite: { message: [32m'Error'[39m }

stderr | src/__tests__/services/mentor/inviteService.test.ts > MentorService > revokeInvite > should return false on error
Erro ao revogar convite: { message: [32m'Error'[39m }

stderr | src/__tests__/services/mentor/inviteService.test.ts > MentorService > getMentees > should return empty array on error
Erro ao buscar alunos: { message: [32m'Error'[39m }

stderr | src/__tests__/services/mentor/inviteService.test.ts > MentorService > getMentors > should return empty array on error
Erro ao buscar mentores: { message: [32m'Error'[39m }

 ‚úì src/__tests__/hooks/useError.test.ts (1 test) 33ms
 ‚úì src/__tests__/services/mentor/inviteService.test.ts (23 tests) 29ms
stderr | src/__tests__/services/journal/review.test.ts > Review Service > createReview > should return null if not authenticated
[createReview] No authenticated user

stderr | src/__tests__/services/journal/review.test.ts > Review Service > createReview > should return null on DB error
[createReview] Error creating review: { message: [32m'DB Error'[39m }

stderr | src/__tests__/services/journal/review.test.ts > Review Service > updateReview > should return false on DB error
[updateReview] Error updating review: { message: [32m'Error'[39m }

stderr | src/__tests__/services/journal/review.test.ts > Review Service > deleteReview > should return false on DB error
[deleteReview] Error deleting review: { message: [32m'Error'[39m }

stderr | src/__tests__/services/journal/review.test.ts > Review Service > getReviewsForMentee > should return empty array on invalid data or error
[getReviewsForMentee] Error fetching reviews: { message: [32m'Error'[39m }

stderr | src/__tests__/services/journal/review.test.ts > Review Service > getMyReviews > should return empty array if not authenticated
[getMyReviews] No authenticated user

stderr | src/__tests__/services/journal/review.test.ts > Review Service > getMyReviews > should return empty array on DB error
[getMyReviews] Error fetching reviews: { message: [32m'Error'[39m }

stderr | src/__tests__/services/journal/review.test.ts > Review Service > getReviewsForTrade > should handle errors
[getReviewsForTrade] Error fetching reviews: { message: [32m'Error'[39m }

stderr | src/__tests__/services/journal/review.test.ts > Review Service > getReviewsForJournalEntry > should handle errors
[getReviewsForJournalEntry] Error fetching reviews: { message: [32m'Error'[39m }

stderr | src/__tests__/services/journal/review.test.ts > Review Service > getReviewsForContext > should handle errors
[getReviewsForContext] Error fetching reviews: { message: [32m'Error'[39m }

stderr | src/__tests__/services/journal/review.test.ts > Review Service > markReviewAsRead > should handle error
[markReviewAsRead] Error updating read status: { message: [32m'Error'[39m }

stderr | src/__tests__/services/journal/review.test.ts > Review Service > getUnreadReviewCount > should return 0 on error
[getUnreadReviewCount] Error fetching count: { message: [32m'Error'[39m }

 ‚úì src/__tests__/services/journal/review.test.ts (25 tests) 25ms
stderr | src/__tests__/lib/errorHandler.test.ts > errorHandler > handleServiceError > should handle Error objects
‚ùå [testContext] Error: Test error
    at [90m/home/jhontavares/Documents/Programacao/Journal-NextJs/[39msrc/__tests__/lib/errorHandler.test.ts:28:21
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

stderr | src/__tests__/lib/errorHandler.test.ts > errorHandler > handleServiceError > should handle string errors
‚ùå [testContext] String error

stderr | src/__tests__/lib/errorHandler.test.ts > errorHandler > handleServiceError > should handle Supabase-style errors
‚ùå [dbInfo] { message: [32m'Supabase error'[39m, code: [32m'PGRST116'[39m }

stderr | src/__tests__/lib/errorHandler.test.ts > errorHandler > handleServiceError > should handle unknown errors
‚ùå [unknownCtx] [33m123[39m

stderr | src/__tests__/lib/errorHandler.test.ts > errorHandler > handleServiceError > should increment metrics
‚ùå [metricsCtx] Error: metrics
    at [90m/home/jhontavares/Documents/Programacao/Journal-NextJs/[39msrc/__tests__/lib/errorHandler.test.ts:81:26
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

stderr | src/__tests__/lib/errorHandler.test.ts > errorHandler > handleServiceError > should call toast handler if registered and enabled
‚ùå [toastCtx] Error: Toast me
    at [90m/home/jhontavares/Documents/Programacao/Journal-NextJs/[39msrc/__tests__/lib/errorHandler.test.ts:89:26
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

stderr | src/__tests__/lib/errorHandler.test.ts > errorHandler > handleServiceError > should utilize userMessage for toast
‚ùå [userMsgCtx] Error: Technical error
    at [90m/home/jhontavares/Documents/Programacao/Journal-NextJs/[39msrc/__tests__/lib/errorHandler.test.ts:97:26
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

stderr | src/__tests__/lib/errorHandler.test.ts > errorHandler > handleServiceError > should not call toast if showToast is false
‚ùå [hiddenCtx] Error: Hidden
    at [90m/home/jhontavares/Documents/Programacao/Journal-NextJs/[39msrc/__tests__/lib/errorHandler.test.ts:108:26
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

stderr | src/__tests__/lib/errorHandler.test.ts > errorHandler > safeAsync > should return null and handle error on failure
‚ùå [asyncFailCtx] Error: Async failure
    at [90m/home/jhontavares/Documents/Programacao/Journal-NextJs/[39msrc/__tests__/lib/errorHandler.test.ts:121:21
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

 ‚úì src/__tests__/lib/errorHandler.test.ts (11 tests) 30ms
stderr | src/__tests__/services/admin/migration.test.ts > Migration Service > should fail gracefully if user is not authenticated
‚ùå User not authenticated. Cannot migrate.

stdout | src/__tests__/services/admin/migration.test.ts > Migration Service > should migrate accounts correctly
üöÄ Starting migration to Supabase...
Found 1 accounts to migrate.

stdout | src/__tests__/services/admin/migration.test.ts > Migration Service > should migrate accounts correctly
Found 0 trades to migrate.
Found 0 journal entries to migrate.
Found 0 daily routines to migrate.
‚úÖ Migration completed successfully!

stdout | src/__tests__/services/admin/migration.test.ts > Migration Service > should migrate trades correctly
üöÄ Starting migration to Supabase...
Found 0 accounts to migrate.
Found 1 trades to migrate.

stdout | src/__tests__/services/admin/migration.test.ts > Migration Service > should migrate trades correctly
Found 0 journal entries to migrate.
Found 0 daily routines to migrate.
‚úÖ Migration completed successfully!

stdout | src/__tests__/services/admin/migration.test.ts > Migration Service > should migrate journal entries with images
üöÄ Starting migration to Supabase...
Found 0 accounts to migrate.
Found 0 trades to migrate.
Found 1 journal entries to migrate.
Migrating images for entry entry-1...

stdout | src/__tests__/services/admin/migration.test.ts > Migration Service > should migrate journal entries with images
Found 0 daily routines to migrate.
‚úÖ Migration completed successfully!

stderr | src/__tests__/services/admin/migration.test.ts > Migration Service > should handle error during migration
‚ùå Migration failed: Error: Fatal error
    at [90m/home/jhontavares/Documents/Programacao/Journal-NextJs/[39msrc/__tests__/services/admin/migration.test.ts:120:53
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

 ‚úì src/__tests__/services/admin/migration.test.ts (5 tests) 30ms
stdout | src/lib/__tests__/integration/backward-compat.test.ts > Backward Compatibility > Data Structure Compatibility > should return data with same structure as old queries
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:35.111Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/__tests__/integration/backward-compat.test.ts > Backward Compatibility > Data Structure Compatibility > should return data with same structure as old queries
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:35.116Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  count: [33m1[39m,
  durationMs: [33m4[39m
}

stdout | src/lib/__tests__/integration/backward-compat.test.ts > Backward Compatibility > Data Structure Compatibility > should return trade objects with expected keys
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:35.118Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/__tests__/integration/backward-compat.test.ts > Backward Compatibility > Data Structure Compatibility > should return trade objects with expected keys
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:35.118Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/__tests__/integration/backward-compat.test.ts > Backward Compatibility > Data Structure Compatibility > should properly map snake_case to camelCase
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:35.119Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/__tests__/integration/backward-compat.test.ts > Backward Compatibility > Data Structure Compatibility > should properly map snake_case to camelCase
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:35.119Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/__tests__/integration/backward-compat.test.ts > Backward Compatibility > Filter and Order Compatibility > should apply orderBy correctly
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:35.122Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  options: { orderBy: [32m'entry_date'[39m, ascending: [33mtrue[39m }
}

stdout | src/lib/__tests__/integration/backward-compat.test.ts > Backward Compatibility > Filter and Order Compatibility > should apply orderBy correctly
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:35.122Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/__tests__/integration/backward-compat.test.ts > Backward Compatibility > Filter and Order Compatibility > should apply limit and offset correctly
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:35.125Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  options: { limit: [33m10[39m, offset: [33m20[39m }
}

stdout | src/lib/__tests__/integration/backward-compat.test.ts > Backward Compatibility > Filter and Order Compatibility > should apply limit and offset correctly
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:35.125Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-1'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

 ‚úì src/__tests__/lib/errorMetrics.test.ts (6 tests) 34ms
 ‚úì src/lib/__tests__/integration/backward-compat.test.ts (8 tests) 18ms
stderr | src/__tests__/services/journal/routine.test.ts > Routine Service > getDailyRoutines > should return empty array if user not authenticated
User not authenticated

stderr | src/__tests__/services/journal/routine.test.ts > Routine Service > getDailyRoutines > should return empty array on DB error
Error fetching daily routines: { message: [32m'Error'[39m }

stderr | src/__tests__/services/journal/routine.test.ts > Routine Service > saveDailyRoutine > should return false if user not authenticated
User not authenticated

stderr | src/__tests__/services/journal/routine.test.ts > Routine Service > saveDailyRoutine > should return false on DB error
Error saving daily routine: { message: [32m'Error'[39m }

stderr | src/__tests__/services/journal/routine.test.ts > Routine Service > deleteDailyRoutine > should return false if user not authenticated
User not authenticated

stderr | src/__tests__/services/journal/routine.test.ts > Routine Service > deleteDailyRoutine > should return false on DB error
Error deleting daily routine: { message: [32m'Error'[39m }

 ‚úì src/__tests__/services/journal/routine.test.ts (11 tests) 17ms
stdout | src/__tests__/services/journal/journalEntry.images.test.ts > Journal Entry - Images > deleteJournalEntry with images > deve deletar imagens do storage ao deletar entrada
Deleting images from storage: [ [32m'user/2025/12/11/image1.png'[39m, [32m'user/2025/12/11/image2.png'[39m ]

stdout | src/__tests__/services/journal/journalEntry.images.test.ts > Journal Entry - Images > deleteJournalEntry with images > deve continuar deletando entrada mesmo se storage falhar
Deleting images from storage: [ [32m'test.png'[39m ]

 ‚úì src/__tests__/services/journal/journalEntry.images.test.ts (6 tests) 16ms
stdout | src/__tests__/services/journal/journalEntry.crud.test.ts > Journal Entry - CRUD Operations > deleteJournalEntry > deve deletar imagens do storage antes de deletar entrada
Deleting images from storage: [ [32m'user/image1.png'[39m, [32m'user/image2.png'[39m ]

 ‚úì src/__tests__/services/journal/journalEntry.crud.test.ts (16 tests) 16ms
 ‚úì src/__tests__/services/trades/trade.test.ts (16 tests) 12ms
 ‚úì src/lib/validation/tradeValidation.test.ts (40 tests) 11ms
 ‚úì src/__tests__/services/importService.test.ts (13 tests) 25ms
 ‚úì src/__tests__/lib/utils/general.test.ts (16 tests) 17ms
 ‚úì src/__tests__/services/tradovateParser.test.ts (19 tests) 11ms
stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository > getByIdDomain > should return trade if found
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:25:36.425Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m't1'[39m,
  withAuthCheck: [33mfalse[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository > getByIdDomain > should perform ownership check if userId provided
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:25:36.430Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m't1'[39m,
  withAuthCheck: [33mtrue[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository > getByIdDomain > should return error if ownership check fails
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:25:36.431Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m't1'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository > getByIdDomain > should return error if ownership check fails
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:25:36.431Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m't1'[39m,
  userId: [32m'u2'[39m,
  ownerId: [32m'u1'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository > getByJournalId > should fetch trades via junction table join
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:25:36.433Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository > getByJournalId > should fetch trades via junction table join
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:25:36.433Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

 ‚úì src/lib/repositories/__tests__/TradeRepository.test.ts (4 tests) 14ms
 ‚úì src/__tests__/services/journal/journalEntry.security.test.ts (9 tests) 8ms
 ‚úì src/__tests__/services/journal/journalEntry.business.test.ts (12 tests) 8ms
 ‚úì src/__tests__/lib/timeframeUtils.test.ts (26 tests) 7ms
 ‚úì src/__tests__/services/core/account.test.ts (19 tests) 13ms
 ‚úì src/__tests__/services/importParsers.test.ts (5 tests) 19ms
 ‚úì src/__tests__/services/exportService.test.ts (3 tests) 14ms
 ‚úì src/__tests__/schemas/schemas.test.ts (10 tests) 9ms
 ‚úì src/__tests__/services/tagAnalyticsService.test.ts (12 tests) 6ms
 ‚úì src/__tests__/services/journal/journalEntry.validation.test.ts (11 tests) 9ms
 ‚úì src/__tests__/services/journal/journalEntry.trades.test.ts (5 tests) 11ms
 ‚úì src/__tests__/lib/password-validator.test.ts (9 tests) 6ms
 ‚úì src/__tests__/services/taxService.test.ts (7 tests) 6ms
 ‚úì src/__tests__/laboratory/recap-journal-link.test.ts (10 tests) 4ms
 ‚úì src/__tests__/lib/errors.test.ts (12 tests) 4ms
 ‚úì src/__tests__/services/ninjaTraderParser.test.ts (13 tests) 8ms

 Test Files  54 passed (54)
      Tests  573 passed (573)
   Start at  18:25:29
   Duration  8.34s (transform 1.68s, setup 4.43s, import 8.12s, tests 5.99s, environment 30.01s)

 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |   66.82 |    57.96 |    65.5 |   68.86 |                   
 ...sts__/fixtures |     100 |      100 |     100 |     100 |                   
  ...y.fixtures.ts |     100 |      100 |     100 |     100 |                   
 ...onents/journal |   46.93 |    47.36 |   46.15 |   48.83 |                   
  ...tailModal.tsx |   46.93 |    47.36 |   46.15 |   48.83 | ...81-190,239-279 
 ...s/journal/form |   81.03 |    78.26 |      76 |   85.18 |                   
  EntryHeader.tsx  |     100 |      100 |     100 |     100 |                   
  ...lAnalysis.tsx |     100 |      100 |     100 |     100 |                   
  ...EntryForm.tsx |   71.79 |    74.35 |   33.33 |   77.77 | ...23-130,134,207 
  ...nalReview.tsx |     100 |      100 |     100 |     100 |                   
  ...radeModal.tsx |     100 |    72.22 |     100 |     100 | 65-114            
  TradeLinker.tsx  |     100 |      100 |     100 |     100 |                   
 components/shared |   11.11 |        0 |       0 |    12.5 |                   
  AssetIcon.tsx    |   11.11 |        0 |       0 |    12.5 | 46-137            
 ...s/trades/hooks |    93.1 |       70 |   85.71 |   96.07 |                   
  ...Validation.ts |    93.1 |       70 |   85.71 |   96.07 | 121,198           
 .../trades/shared |   91.83 |    93.54 |      75 |     100 |                   
  ...uenceTags.tsx |   85.18 |      100 |   66.66 |     100 |                   
  ...wardCards.tsx |     100 |      100 |     100 |     100 |                   
  ...eWithIcon.tsx |     100 |      100 |     100 |     100 |                   
  ...sultBadge.tsx |     100 |     87.5 |     100 |     100 | 40                
 components/ui     |   71.98 |    59.24 |   60.27 |   71.94 |                   
  AssetBadge.tsx   |     100 |      100 |     100 |     100 |                   
  Button.tsx       |     100 |    55.31 |     100 |     100 | 151,162-209       
  Card.tsx         |     100 |      100 |     100 |     100 |                   
  ...rProgress.tsx |       0 |        0 |       0 |       0 | 22-26             
  FormLayout.tsx   |      80 |    56.25 |   66.66 |      80 | 35                
  GlassCard.tsx    |       0 |        0 |       0 |       0 | 29-103            
  ...ionButton.tsx |     100 |      100 |     100 |     100 |                   
  Input.tsx        |     100 |    89.65 |     100 |     100 | 18-19,27          
  Modal.tsx        |   78.57 |    56.25 |      80 |   83.33 | 34-35             
  ...erActions.tsx |   93.75 |    87.17 |     100 |   93.75 | 86                
  PageSkeleton.tsx |       0 |      100 |       0 |       0 | 8-50              
  ...tedToggle.tsx |    8.33 |        0 |       0 |    9.09 | 36-68             
  Select.tsx       |     100 |     90.9 |     100 |     100 | 30                
  Tabs.tsx         |     100 |     87.5 |     100 |     100 | 37                
  Toast.tsx        |    9.09 |        0 |       0 |    9.52 | 34-94             
  WeekPicker.tsx   |   86.48 |     82.5 |   77.77 |   85.71 | ...22,331-333,385 
  index.ts         |       0 |        0 |       0 |       0 |                   
  switch.tsx       |   66.66 |      100 |       0 |   66.66 | 11                
 constants         |   22.22 |        0 |       0 |   22.22 |                   
  assetIcons.ts    |   22.22 |        0 |       0 |   22.22 | 345-371           
 hooks             |   97.58 |    85.36 |     100 |   97.54 |                   
  ...BodyScroll.ts |     100 |      100 |     100 |     100 |                   
  useError.ts      |     100 |      100 |     100 |     100 |                   
  useImageCache.ts |   96.87 |    82.85 |     100 |   96.84 | 131,141,332       
 lib               |   50.85 |    48.34 |   44.59 |   54.26 |                   
  calculations.ts  |   12.77 |    13.13 |    11.9 |   13.19 | ...42-165,182-390 
  errorHandler.ts  |     100 |    89.28 |     100 |     100 | 102,134           
  errorMetrics.ts  |   95.83 |    76.47 |     100 |   95.23 | 57                
  errors.ts        |     100 |      100 |     100 |     100 |                   
  ...-validator.ts |   91.66 |    83.33 |     100 |   94.11 | 67,69             
  storage.ts       |       0 |        0 |       0 |       0 |                   
  ...frameUtils.ts |   62.26 |       60 |   72.72 |   64.04 | ...85-311,359,379 
  utils.ts         |       0 |      100 |       0 |       0 | 5                 
 lib/logging       |   27.41 |    19.29 |      50 |   27.58 |                   
  Logger.ts        |      50 |       50 |      70 |   51.72 | 17,48,68-96       
  safeError.ts     |    3.33 |        0 |       0 |    3.44 | 29-53,100-151     
 lib/repositories  |   45.65 |    48.52 |   46.15 |   48.83 |                   
  ...Repository.ts |   26.66 |    16.66 |   16.66 |      32 | 25-31,48-84       
  ...Repository.ts |   50.92 |    55.35 |   71.42 |   52.88 | ...54-347,398-445 
 lib/supabase      |     100 |      100 |     100 |     100 |                   
  fragments.ts     |     100 |      100 |     100 |     100 |                   
 lib/utils         |   79.76 |     70.4 |   84.61 |    81.7 |                   
  general.ts       |   98.11 |    95.65 |     100 |     100 | 113               
  ...ompression.ts |   72.54 |    63.63 |   78.94 |   73.73 | ...80,301,329-331 
  trade.ts         |   66.66 |       60 |     100 |      75 | 24,29-33          
 lib/validation    |   85.18 |    76.97 |   94.44 |   85.93 |                   
  ...Validation.ts |    87.6 |    79.16 |    92.3 |   87.06 | ...04,420,436-439 
  ...tion.types.ts |   64.28 |     37.5 |     100 |      75 | 94-96             
 schemas           |     100 |      100 |     100 |     100 |                   
  authSchema.ts    |     100 |      100 |     100 |     100 |                   
  journalSchema.ts |     100 |      100 |     100 |     100 |                   
  tradeSchema.ts   |     100 |      100 |     100 |     100 |                   
 services/admin    |   82.45 |    47.36 |      50 |   82.45 |                   
  migration.ts     |   82.45 |    47.36 |      50 |   82.45 | ...07,136,142-144 
 ...ices/analytics |   72.51 |    45.77 |   76.78 |   74.67 |                   
  report.ts        |    87.6 |    53.33 |   95.23 |   89.62 | 128,197,215-223   
  tagAnalytics.ts  |   48.78 |    27.77 |   59.25 |   48.52 | 79,143-232        
  tax.ts           |   74.57 |    64.28 |    87.5 |   78.18 | 189-209           
 services/core     |   73.03 |    67.85 |     100 |   78.94 |                   
  account.ts       |   73.03 |    67.85 |     100 |   78.94 | ...94-295,340-341 
 services/journal  |   75.44 |     67.8 |   92.85 |      75 |                   
  journal.ts       |   53.38 |     52.5 |   83.33 |   52.67 | ...92,306,342,352 
  review.ts        |     100 |    84.61 |     100 |     100 | ...41,261,302,346 
  routine.ts       |     100 |    92.85 |     100 |     100 | 84                
 ...mentor/invites |    42.4 |    37.12 |   35.29 |   42.94 |                   
  index.ts         |       0 |        0 |       0 |       0 |                   
  manage.ts        |   52.94 |    36.36 |   42.85 |   53.12 | 78-158            
  receive.ts       |   38.28 |    32.95 |   31.81 |   38.18 | ...13,167,191-439 
  send.ts          |   48.14 |    44.44 |   33.33 |      50 | 15-40,68,101-102  
  types.ts         |      50 |      100 |      50 |      50 | 55                
 services/trades   |   68.28 |     61.3 |   70.11 |   69.97 |                   
  export.ts        |   69.09 |       75 |   78.57 |   67.34 | 36-37,169,220-240 
  import.ts        |   63.91 |       55 |   68.96 |   66.98 | ...71,690,727-741 
  importParsers.ts |   90.96 |    69.11 |    87.5 |   91.12 | ...30,401-402,426 
  mappers.ts       |      75 |    83.33 |      50 |     100 | 84                
  trade.ts         |   76.25 |    65.51 |     100 |      80 | ...59-260,282-283 
  ...vateParser.ts |    52.4 |     54.8 |      50 |   53.23 | ...72-324,336-399 
-------------------|---------|----------|---------|---------|-------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/__tests__/components/ui/VisualComponents.test.tsx x1 

stderr | src/__tests__/components/ui/VisualComponents.test.tsx > UI Components Part 2 > AssetIcon > should render single icon for non-pair
Received `true` for a non-boolean attribute `fill`.

If you want to write it to the DOM, pass a string instead: fill="true" or fill={value.toString()}.
Received `true` for a non-boolean attribute `unoptimized`.

If you want to write it to the DOM, pass a string instead: unoptimized="true" or unoptimized={value.toString()}.

 ‚úì src/__tests__/components/ui/VisualComponents.test.tsx (11 tests) 250ms

 Test Files  1 passed (1)
      Tests  11 passed (11)
   Start at  18:30:03
   Duration  406ms

 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |   36.66 |    54.38 |   56.52 |    36.9 |                   
 components/shared |   88.88 |     87.5 |      75 |    87.5 |                   
  AssetIcon.tsx    |   88.88 |     87.5 |      75 |    87.5 | 103,137           
 components/ui     |      90 |    95.83 |   83.33 |      90 |                   
  ...rProgress.tsx |     100 |      100 |     100 |     100 |                   
  GlassCard.tsx    |   83.33 |    92.85 |      80 |   83.33 | 94                
 constants         |   66.66 |       50 |   33.33 |   66.66 |                   
  assetIcons.ts    |   66.66 |       50 |   33.33 |   66.66 | 350,364-371       
 lib/utils         |    3.77 |        0 |   16.66 |    4.08 |                   
  general.ts       |    3.77 |        0 |   16.66 |    4.08 | 12-34,53-133      
-------------------|---------|----------|---------|---------|-------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/__tests__/hooks/HooksAndUtils.test.tsx x1 

 ‚úì src/__tests__/hooks/HooksAndUtils.test.tsx (7 tests) 170ms

 Test Files  1 passed (1)
      Tests  7 passed (7)
   Start at  18:30:31
   Duration  310ms

 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |   35.44 |    32.35 |      50 |   36.48 |                   
 components/ui     |     100 |      100 |     100 |     100 |                   
  ...ionButton.tsx |     100 |      100 |     100 |     100 |                   
 hooks             |     100 |      100 |     100 |     100 |                   
  ...BodyScroll.ts |     100 |      100 |     100 |     100 |                   
 lib/utils         |    3.77 |        0 |   16.66 |    4.08 |                   
  general.ts       |    3.77 |        0 |   16.66 |    4.08 | 12-34,53-133      
-------------------|---------|----------|---------|---------|-------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/lib/repositories/__tests__/TradeRepository.test.ts x1 

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:40:42.353Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:40:42.355Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m3[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:40:42.359Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:40:42.359Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  count: [33m0[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respects offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:40:42.360Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: { limit: [33m10[39m, offset: [33m5[39m }
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respects offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:40:42.360Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return trade by ID without auth check
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:40:42.362Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mfalse[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:40:42.363Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:40:42.363Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user'[39m,
  ownerId: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:40:42.364Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:40:42.364Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:40:42.364Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m,
  ownerId: [90mundefined[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:40:42.365Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m,
  errorCode: [32m'AUTH_FORBIDDEN'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:40:42.370Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:40:42.370Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:40:42.370Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  ownerId: [90mundefined[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:40:42.370Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  errorCode: [32m'AUTH_FORBIDDEN'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:40:42.371Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:40:42.371Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Query failed'[39m,
  timestamp: [32m'2025-12-19T21:40:42.371Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { code: [32m'PGRST116'[39m, message: [32m'Not found'[39m }
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:40:42.371Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m,
  errorCode: [32m'DB_NOT_FOUND'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should create trade and associate with journal if authorized
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Creating trade with junction table association'[39m,
  timestamp: [32m'2025-12-19T21:40:42.374Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  userId: [32m'u1'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should create trade and associate with journal if authorized
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade created and associated successfully'[39m,
  timestamp: [32m'2025-12-19T21:40:42.375Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'new-trade-id'[39m,
  journalId: [32m'j1'[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should rollback trade creation if association fails
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Creating trade with junction table association'[39m,
  timestamp: [32m'2025-12-19T21:40:42.376Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  userId: [32m'u1'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should rollback trade creation if association fails
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to create junction entry, rolling back trade'[39m,
  timestamp: [32m'2025-12-19T21:40:42.376Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Failed relation'[39m }
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByAccountId > should return trades for account ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by account ID'[39m,
  timestamp: [32m'2025-12-19T21:40:42.378Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  accountId: [32m'account-xyz'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:40:42.379Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to fetch trades by journal ID'[39m,
  timestamp: [32m'2025-12-19T21:40:42.379Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Connection failed'[39m, code: [32m'MakeItFail'[39m },
  journalId: [32m'journal-123'[39m
}

 ‚ùØ src/lib/repositories/__tests__/TradeRepository.test.ts (12 tests | 2 failed) 29ms
       ‚úì should return trades for valid journal ID 7ms
       ‚úì should return empty array if journal has no trades 1ms
       ‚úì should respects offset and limit for pagination 1ms
       ‚úì should return trade by ID without auth check 1ms
       ‚úì should return error if userId does not match 1ms
       √ó should return trade if userId is correct 6ms
       ‚úì should return error if userId is incorrect 1ms
       √ó should return error if trade not found 3ms
       ‚úì should create trade and associate with journal if authorized 1ms
       ‚úì should rollback trade creation if association fails 2ms
       ‚úì should return trades for account ID 1ms
       ‚úì should handle database errors gracefully 1ms

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Tests 2 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
AssertionError: expected undefined to be 'user-abc' // Object.is equality

[32m- Expected:[39m 
"user-abc"

[31m+ Received:[39m 
undefined

 ‚ùØ src/lib/repositories/__tests__/TradeRepository.test.ts:120:42
    118| 
    119|             const result = await repo.getByIdWithAuth("trade-123", "us‚Ä¶
    120|             expect(result.data?.user_id).toBe("user-abc");
       |                                          ^
    121|         });
    122| 

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/2]‚éØ

 FAIL  src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
AssertionError: expected 'AUTH_FORBIDDEN' to be 'DB_NOT_FOUND' // Object.is equality

Expected: [32m"DB_NOT_FOUND"[39m
Received: [31m"AUTH_FORBIDDEN"[39m

 ‚ùØ src/lib/repositories/__tests__/TradeRepository.test.ts:144:40
    142| 
    143|             const result = await repo.getByIdWithAuth("non-existent-tr‚Ä¶
    144|             expect(result.error?.code).toBe(ErrorCode.DB_NOT_FOUND); /‚Ä¶
       |                                        ^
    145|             // BaseRepository maps PGRST116 to DB_NOT_FOUND usually, l‚Ä¶
    146|             // If getByIdDomain returns DB_NOT_FOUND via BaseRepositor‚Ä¶

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[2/2]‚éØ


 Test Files  1 failed (1)
      Tests  2 failed | 10 passed (12)
   Start at  18:40:41
   Duration  95ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/lib/repositories/__tests__/TradeRepository.test.ts x2 

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:06.287Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:06.291Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m4[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:06.296Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:06.296Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  count: [33m0[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respects offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:06.297Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: { limit: [33m10[39m, offset: [33m5[39m }
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respects offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:06.297Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return trade by ID without auth check
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:06.299Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mfalse[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:06.300Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:41:06.300Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user'[39m,
  ownerId: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:41:06.302Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:06.302Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:41:06.302Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m,
  ownerId: [90mundefined[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:41:06.302Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m,
  errorCode: [32m'AUTH_FORBIDDEN'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:41:06.310Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:06.310Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:41:06.310Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  ownerId: [90mundefined[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:41:06.310Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  errorCode: [32m'AUTH_FORBIDDEN'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:41:06.311Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:06.311Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Query failed'[39m,
  timestamp: [32m'2025-12-19T21:41:06.311Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { code: [32m'PGRST116'[39m, message: [32m'Not found'[39m }
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:41:06.312Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m,
  errorCode: [32m'DB_NOT_FOUND'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should create trade and associate with journal if authorized
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Creating trade with junction table association'[39m,
  timestamp: [32m'2025-12-19T21:41:06.312Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  userId: [32m'u1'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should create trade and associate with journal if authorized
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade created and associated successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:06.313Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'new-trade-id'[39m,
  journalId: [32m'j1'[39m,
  durationMs: [33m1[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should rollback trade creation if association fails
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Creating trade with junction table association'[39m,
  timestamp: [32m'2025-12-19T21:41:06.314Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  userId: [32m'u1'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should rollback trade creation if association fails
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to create junction entry, rolling back trade'[39m,
  timestamp: [32m'2025-12-19T21:41:06.315Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Failed relation'[39m }
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByAccountId > should return trades for account ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by account ID'[39m,
  timestamp: [32m'2025-12-19T21:41:06.316Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  accountId: [32m'account-xyz'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:06.317Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to fetch trades by journal ID'[39m,
  timestamp: [32m'2025-12-19T21:41:06.317Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Connection failed'[39m, code: [32m'MakeItFail'[39m },
  journalId: [32m'journal-123'[39m
}

 ‚ùØ src/lib/repositories/__tests__/TradeRepository.test.ts (12 tests | 1 failed) 34ms
       ‚úì should return trades for valid journal ID 10ms
       ‚úì should return empty array if journal has no trades 1ms
       ‚úì should respects offset and limit for pagination 1ms
       ‚úì should return trade by ID without auth check 1ms
       ‚úì should return error if userId does not match 2ms
       √ó should return trade if userId is correct 8ms
       ‚úì should return error if userId is incorrect 1ms
       ‚úì should return error if trade not found 1ms
       ‚úì should create trade and associate with journal if authorized 2ms
       ‚úì should rollback trade creation if association fails 2ms
       ‚úì should return trades for account ID 1ms
       ‚úì should handle database errors gracefully 1ms

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Tests 1 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
AssertionError: expected undefined to be 'user-abc' // Object.is equality

[32m- Expected:[39m 
"user-abc"

[31m+ Received:[39m 
undefined

 ‚ùØ src/lib/repositories/__tests__/TradeRepository.test.ts:121:41
    119|             const result = await repo.getByIdWithAuth("trade-123", "us‚Ä¶
    120|             // Mapper converts user_id to userId
    121|             expect(result.data?.userId).toBe("user-abc");
       |                                         ^
    122|         });
    123| 

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ


 Test Files  1 failed (1)
      Tests  1 failed | 11 passed (12)
   Start at  18:41:05
   Duration  103ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/lib/tests/utils/factories.ts x3 

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:37.612Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:37.614Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m3[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:37.618Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:37.619Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  count: [33m0[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respects offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:37.619Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: { limit: [33m10[39m, offset: [33m5[39m }
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respects offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:37.620Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return trade by ID without auth check
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:37.621Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mfalse[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:37.622Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:41:37.622Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user'[39m,
  ownerId: [32m'user-123'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:41:37.624Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:37.624Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:41:37.624Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m,
  ownerId: [32m'user-123'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:41:37.624Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m,
  errorCode: [32m'AUTH_FORBIDDEN'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:41:37.630Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:37.630Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:41:37.631Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  ownerId: [32m'user-123'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:41:37.631Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  errorCode: [32m'AUTH_FORBIDDEN'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:41:37.632Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:37.632Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Query failed'[39m,
  timestamp: [32m'2025-12-19T21:41:37.632Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { code: [32m'PGRST116'[39m, message: [32m'Not found'[39m }
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:41:37.632Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m,
  errorCode: [32m'DB_NOT_FOUND'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should create trade and associate with journal if authorized
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Creating trade with junction table association'[39m,
  timestamp: [32m'2025-12-19T21:41:37.633Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  userId: [32m'u1'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should create trade and associate with journal if authorized
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade created and associated successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:37.633Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'new-trade-id'[39m,
  journalId: [32m'j1'[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should rollback trade creation if association fails
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Creating trade with junction table association'[39m,
  timestamp: [32m'2025-12-19T21:41:37.634Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  userId: [32m'u1'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should rollback trade creation if association fails
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to create junction entry, rolling back trade'[39m,
  timestamp: [32m'2025-12-19T21:41:37.635Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Failed relation'[39m }
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByAccountId > should return trades for account ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by account ID'[39m,
  timestamp: [32m'2025-12-19T21:41:37.636Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  accountId: [32m'account-xyz'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:37.637Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to fetch trades by journal ID'[39m,
  timestamp: [32m'2025-12-19T21:41:37.637Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Connection failed'[39m, code: [32m'MakeItFail'[39m },
  journalId: [32m'journal-123'[39m
}

 ‚ùØ src/lib/repositories/__tests__/TradeRepository.test.ts (12 tests | 1 failed) 28ms
       ‚úì should return trades for valid journal ID 7ms
       ‚úì should return empty array if journal has no trades 1ms
       ‚úì should respects offset and limit for pagination 1ms
       ‚úì should return trade by ID without auth check 1ms
       ‚úì should return error if userId does not match 1ms
       √ó should return trade if userId is correct 7ms
       ‚úì should return error if userId is incorrect 1ms
       ‚úì should return error if trade not found 1ms
       ‚úì should create trade and associate with journal if authorized 1ms
       ‚úì should rollback trade creation if association fails 2ms
       ‚úì should return trades for account ID 1ms
       ‚úì should handle database errors gracefully 1ms

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Tests 1 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
AssertionError: expected undefined to be 'user-abc' // Object.is equality

[32m- Expected:[39m 
"user-abc"

[31m+ Received:[39m 
undefined

 ‚ùØ src/lib/repositories/__tests__/TradeRepository.test.ts:121:41
    119|             const result = await repo.getByIdWithAuth("trade-123", "us‚Ä¶
    120|             // Mapper converts user_id to userId
    121|             expect(result.data?.userId).toBe("user-abc");
       |                                         ^
    122|         });
    123| 

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ


 Test Files  1 failed (1)
      Tests  1 failed | 11 passed (12)
   Start at  18:41:37
   Duration  100ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/lib/tests/utils/factories.ts x4 

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:40.098Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:40.101Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m3[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:40.105Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:40.105Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  count: [33m0[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respects offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:40.106Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: { limit: [33m10[39m, offset: [33m5[39m }
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respects offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:40.106Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return trade by ID without auth check
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:40.108Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mfalse[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:40.109Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:41:40.109Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user'[39m,
  ownerId: [32m'user-123'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:41:40.110Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:40.110Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:41:40.111Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m,
  ownerId: [32m'user-123'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:41:40.111Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m,
  errorCode: [32m'AUTH_FORBIDDEN'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:41:40.117Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:40.117Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:41:40.117Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  ownerId: [32m'user-123'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:41:40.118Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  errorCode: [32m'AUTH_FORBIDDEN'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:41:40.118Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:40.118Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Query failed'[39m,
  timestamp: [32m'2025-12-19T21:41:40.119Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { code: [32m'PGRST116'[39m, message: [32m'Not found'[39m }
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:41:40.119Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m,
  errorCode: [32m'DB_NOT_FOUND'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should create trade and associate with journal if authorized
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Creating trade with junction table association'[39m,
  timestamp: [32m'2025-12-19T21:41:40.120Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  userId: [32m'u1'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should create trade and associate with journal if authorized
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade created and associated successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:40.120Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'new-trade-id'[39m,
  journalId: [32m'j1'[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should rollback trade creation if association fails
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Creating trade with junction table association'[39m,
  timestamp: [32m'2025-12-19T21:41:40.121Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  userId: [32m'u1'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should rollback trade creation if association fails
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to create junction entry, rolling back trade'[39m,
  timestamp: [32m'2025-12-19T21:41:40.122Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Failed relation'[39m }
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByAccountId > should return trades for account ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by account ID'[39m,
  timestamp: [32m'2025-12-19T21:41:40.123Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  accountId: [32m'account-xyz'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:40.124Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to fetch trades by journal ID'[39m,
  timestamp: [32m'2025-12-19T21:41:40.125Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Connection failed'[39m, code: [32m'MakeItFail'[39m },
  journalId: [32m'journal-123'[39m
}

 ‚ùØ src/lib/repositories/__tests__/TradeRepository.test.ts (12 tests | 1 failed) 29ms
       ‚úì should return trades for valid journal ID 8ms
       ‚úì should return empty array if journal has no trades 1ms
       ‚úì should respects offset and limit for pagination 1ms
       ‚úì should return trade by ID without auth check 1ms
       ‚úì should return error if userId does not match 1ms
       √ó should return trade if userId is correct 7ms
       ‚úì should return error if userId is incorrect 1ms
       ‚úì should return error if trade not found 1ms
       ‚úì should create trade and associate with journal if authorized 2ms
       ‚úì should rollback trade creation if association fails 2ms
       ‚úì should return trades for account ID 1ms
       ‚úì should handle database errors gracefully 1ms

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Tests 1 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
AssertionError: expected undefined to be 'user-abc' // Object.is equality

[32m- Expected:[39m 
"user-abc"

[31m+ Received:[39m 
undefined

 ‚ùØ src/lib/repositories/__tests__/TradeRepository.test.ts:121:41
    119|             const result = await repo.getByIdWithAuth("trade-123", "us‚Ä¶
    120|             // Mapper converts user_id to userId
    121|             expect(result.data?.userId).toBe("user-abc");
       |                                         ^
    122|         });
    123| 

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ


 Test Files  1 failed (1)
      Tests  1 failed | 11 passed (12)
   Start at  18:41:39
   Duration  102ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/lib/tests/fixtures/tradeFixtures.ts x5 

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:40.978Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:40.981Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m3[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:40.984Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:40.984Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  count: [33m0[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respects offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:40.985Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: { limit: [33m10[39m, offset: [33m5[39m }
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respects offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:40.985Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return trade by ID without auth check
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:40.986Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mfalse[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:40.987Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:41:40.988Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user'[39m,
  ownerId: [32m'user-123'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:41:40.989Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:40.989Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:41:40.989Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m,
  ownerId: [32m'user-123'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:41:40.989Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m,
  errorCode: [32m'AUTH_FORBIDDEN'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:41:40.996Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:40.996Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:41:40.996Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  ownerId: [32m'user-123'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:41:40.996Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  errorCode: [32m'AUTH_FORBIDDEN'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:41:40.997Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:41:40.997Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Query failed'[39m,
  timestamp: [32m'2025-12-19T21:41:40.997Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { code: [32m'PGRST116'[39m, message: [32m'Not found'[39m }
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:41:40.998Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m,
  errorCode: [32m'DB_NOT_FOUND'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should create trade and associate with journal if authorized
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Creating trade with junction table association'[39m,
  timestamp: [32m'2025-12-19T21:41:40.999Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  userId: [32m'u1'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should create trade and associate with journal if authorized
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade created and associated successfully'[39m,
  timestamp: [32m'2025-12-19T21:41:40.999Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'new-trade-id'[39m,
  journalId: [32m'j1'[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should rollback trade creation if association fails
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Creating trade with junction table association'[39m,
  timestamp: [32m'2025-12-19T21:41:41.000Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  userId: [32m'u1'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should rollback trade creation if association fails
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to create junction entry, rolling back trade'[39m,
  timestamp: [32m'2025-12-19T21:41:41.001Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Failed relation'[39m }
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByAccountId > should return trades for account ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by account ID'[39m,
  timestamp: [32m'2025-12-19T21:41:41.002Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  accountId: [32m'account-xyz'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:41:41.003Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to fetch trades by journal ID'[39m,
  timestamp: [32m'2025-12-19T21:41:41.003Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Connection failed'[39m, code: [32m'MakeItFail'[39m },
  journalId: [32m'journal-123'[39m
}

 ‚ùØ src/lib/repositories/__tests__/TradeRepository.test.ts (12 tests | 1 failed) 28ms
       ‚úì should return trades for valid journal ID 7ms
       ‚úì should return empty array if journal has no trades 1ms
       ‚úì should respects offset and limit for pagination 1ms
       ‚úì should return trade by ID without auth check 1ms
       ‚úì should return error if userId does not match 1ms
       √ó should return trade if userId is correct 7ms
       ‚úì should return error if userId is incorrect 1ms
       ‚úì should return error if trade not found 1ms
       ‚úì should create trade and associate with journal if authorized 2ms
       ‚úì should rollback trade creation if association fails 2ms
       ‚úì should return trades for account ID 1ms
       ‚úì should handle database errors gracefully 1ms

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Tests 1 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
AssertionError: expected undefined to be 'user-abc' // Object.is equality

[32m- Expected:[39m 
"user-abc"

[31m+ Received:[39m 
undefined

 ‚ùØ src/lib/repositories/__tests__/TradeRepository.test.ts:121:41
    119|             const result = await repo.getByIdWithAuth("trade-123", "us‚Ä¶
    120|             // Mapper converts user_id to userId
    121|             expect(result.data?.userId).toBe("user-abc");
       |                                         ^
    122|         });
    123| 

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ


 Test Files  1 failed (1)
      Tests  1 failed | 11 passed (12)
   Start at  18:41:40
   Duration  93ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/lib/repositories/__tests__/TradeRepository.test.ts x6 

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:42:14.212Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return trades for valid journal ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:42:14.215Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m3[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:42:14.219Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should return empty array if journal has no trades
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:42:14.220Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-with-no-trades'[39m,
  count: [33m0[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respects offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:42:14.221Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: { limit: [33m10[39m, offset: [33m5[39m }
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByJournalId > should respects offset and limit for pagination
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trades fetched successfully'[39m,
  timestamp: [32m'2025-12-19T21:42:14.221Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  count: [33m1[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return trade by ID without auth check
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:42:14.222Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mfalse[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:42:14.223Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdDomain > should return error if userId does not match
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:42:14.224Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user'[39m,
  ownerId: [32m'user-123'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return trade if userId is correct
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:42:14.225Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:42:14.225Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:42:14.226Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:42:14.226Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Unauthorized trade access attempt'[39m,
  timestamp: [32m'2025-12-19T21:42:14.226Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  ownerId: [32m'user-abc'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if userId is incorrect
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:42:14.226Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'trade-123'[39m,
  userId: [32m'wrong-user-id'[39m,
  errorCode: [32m'AUTH_FORBIDDEN'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade with strict auth'[39m,
  timestamp: [32m'2025-12-19T21:42:14.227Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m
}
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trade by ID'[39m,
  timestamp: [32m'2025-12-19T21:42:14.227Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  withAuthCheck: [33mtrue[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Query failed'[39m,
  timestamp: [32m'2025-12-19T21:42:14.227Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { code: [32m'PGRST116'[39m, message: [32m'Not found'[39m }
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByIdWithAuth > should return error if trade not found
{
  level: [32m'WARN'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade access denied'[39m,
  timestamp: [32m'2025-12-19T21:42:14.227Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'non-existent-trade'[39m,
  userId: [32m'user-abc'[39m,
  errorCode: [32m'DB_NOT_FOUND'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should create trade and associate with journal if authorized
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Creating trade with junction table association'[39m,
  timestamp: [32m'2025-12-19T21:42:14.228Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  userId: [32m'u1'[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should create trade and associate with journal if authorized
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Trade created and associated successfully'[39m,
  timestamp: [32m'2025-12-19T21:42:14.229Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  tradeId: [32m'new-trade-id'[39m,
  journalId: [32m'j1'[39m,
  durationMs: [33m0[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should rollback trade creation if association fails
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Creating trade with junction table association'[39m,
  timestamp: [32m'2025-12-19T21:42:14.230Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'j1'[39m,
  userId: [32m'u1'[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > createWithJournal > should rollback trade creation if association fails
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to create junction entry, rolling back trade'[39m,
  timestamp: [32m'2025-12-19T21:42:14.230Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Failed relation'[39m }
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > getByAccountId > should return trades for account ID
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by account ID'[39m,
  timestamp: [32m'2025-12-19T21:42:14.231Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  accountId: [32m'account-xyz'[39m,
  options: [90mundefined[39m
}

stdout | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'INFO'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Fetching trades by journal ID via junction table'[39m,
  timestamp: [32m'2025-12-19T21:42:14.232Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  journalId: [32m'journal-123'[39m,
  options: [90mundefined[39m
}

stderr | src/lib/repositories/__tests__/TradeRepository.test.ts > TradeRepository Unit Tests > Database Error Handling > should handle database errors gracefully
{
  level: [32m'ERROR'[39m,
  context: [32m'tradesRepository'[39m,
  message: [32m'Failed to fetch trades by journal ID'[39m,
  timestamp: [32m'2025-12-19T21:42:14.233Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Connection failed'[39m, code: [32m'MakeItFail'[39m },
  journalId: [32m'journal-123'[39m
}

 ‚úì src/lib/repositories/__tests__/TradeRepository.test.ts (12 tests) 24ms

 Test Files  1 passed (1)
      Tests  12 passed (12)
   Start at  18:42:13
   Duration  94ms

 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |   53.93 |    42.13 |   48.14 |   55.08 |                   
 lib               |      50 |    18.18 |      50 |   48.38 |                   
  errors.ts        |      50 |    18.18 |      50 |   48.38 | 42-77             
 lib/logging       |   27.41 |    19.29 |      50 |   27.58 |                   
  Logger.ts        |      50 |       50 |      70 |   51.72 | 17,48,68-96       
  safeError.ts     |    3.33 |        0 |       0 |    3.44 | 29-53,100-151     
 lib/repositories  |   63.76 |    66.17 |      50 |   66.66 |                   
  ...Repository.ts |   46.66 |       50 |   16.66 |      52 | 48-84             
  ...Repository.ts |   68.51 |    69.64 |   78.57 |   70.19 | ...46-347,398-445 
 lib/supabase      |     100 |      100 |     100 |     100 |                   
  fragments.ts     |     100 |      100 |     100 |     100 |                   
 ...tests/fixtures |     100 |      100 |     100 |     100 |                   
  tradeFixtures.ts |     100 |      100 |     100 |     100 |                   
 lib/tests/utils   |   57.14 |      100 |      25 |   58.33 |                   
  factories.ts     |   66.66 |      100 |   33.33 |   66.66 | 39,52             
  mockBuilders.ts  |      50 |      100 |      20 |      50 | 37-39,56          
 services/trades   |     100 |    58.33 |     100 |     100 |                   
  mappers.ts       |     100 |    58.33 |     100 |     100 | 24-44             
-------------------|---------|----------|---------|---------|-------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/services/journal/__tests__/journalServiceNew.test.ts x1 


‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Suites 1 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  src/services/journal/__tests__/journalServiceNew.test.ts [ src/services/journal/__tests__/journalServiceNew.test.ts ]
Error: [vitest] There was an error when mocking a module. If you are using "vi.mock" factory, make sure there are no top level variables inside, since this call is hoisted to top of the file. Read more: https://vitest.dev/api/vi.html#vi-mock
 ‚ùØ src/services/journal/journal.ts:1:1
      1| import { supabase } from "@/lib/supabase";
       | ^
      2| import { handleServiceError } from "@/lib/errorHandler";
      3| import { ensureFreshImageUrl } from "@/lib/utils/general";

Caused by: ReferenceError: Cannot access '__vi_import_1__' before initialization
 ‚ùØ src/services/journal/__tests__/journalServiceNew.test.ts:9:15

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ


 Test Files  1 failed (1)
      Tests  no tests
   Start at  18:42:48
   Duration  56ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/services/journal/__tests__/journalServiceNew.test.ts x2 


‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Suites 1 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  src/services/journal/__tests__/journalServiceNew.test.ts [ src/services/journal/__tests__/journalServiceNew.test.ts ]
Error: [vitest] There was an error when mocking a module. If you are using "vi.mock" factory, make sure there are no top level variables inside, since this call is hoisted to top of the file. Read more: https://vitest.dev/api/vi.html#vi-mock
 ‚ùØ src/services/journal/journal.ts:1:1
      1| import { supabase } from "@/lib/supabase";
       | ^
      2| import { handleServiceError } from "@/lib/errorHandler";
      3| import { ensureFreshImageUrl } from "@/lib/utils/general";

Caused by: ReferenceError: Cannot access 'mockSupabase' before initialization
 ‚ùØ src/services/journal/__tests__/journalServiceNew.test.ts:23:15

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ


 Test Files  1 failed (1)
      Tests  no tests
   Start at  18:43:07
   Duration  62ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/services/journal/__tests__/journalServiceNew.test.ts x3 

 ‚úì src/services/journal/__tests__/journalServiceNew.test.ts (3 tests) 10ms

 Test Files  1 passed (1)
      Tests  3 passed (3)
   Start at  18:43:24
   Duration  86ms

 % Coverage report from v8
------------------|---------|----------|---------|---------|--------------------
File              | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s  
------------------|---------|----------|---------|---------|--------------------
All files         |   42.93 |    33.98 |   42.85 |   43.71 |                    
 lib/tests/utils  |   66.66 |      100 |   33.33 |   66.66 |                    
  factories.ts    |   66.66 |      100 |   33.33 |   66.66 | 9,39               
 lib/utils        |   18.86 |     8.69 |   16.66 |    20.4 |                    
  general.ts      |   18.86 |     8.69 |   16.66 |    20.4 | ...-94,119,132-133 
 services/journal |   52.54 |    41.25 |   58.33 |   52.67 |                    
  journal.ts      |   52.54 |    41.25 |   58.33 |   52.67 | ...342-352,367-406 
------------------|---------|----------|---------|---------|--------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/services/journal/__tests__/journalServiceNew.test.ts x4 

 ‚úì src/services/journal/__tests__/journalServiceNew.test.ts (3 tests) 9ms

 Test Files  1 passed (1)
      Tests  3 passed (3)
   Start at  18:43:27
   Duration  76ms

 % Coverage report from v8
------------------|---------|----------|---------|---------|--------------------
File              | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s  
------------------|---------|----------|---------|---------|--------------------
All files         |   42.93 |    33.98 |   42.85 |   43.71 |                    
 lib/tests/utils  |   66.66 |      100 |   33.33 |   66.66 |                    
  factories.ts    |   66.66 |      100 |   33.33 |   66.66 | 9,39               
 lib/utils        |   18.86 |     8.69 |   16.66 |    20.4 |                    
  general.ts      |   18.86 |     8.69 |   16.66 |    20.4 | ...-94,119,132-133 
 services/journal |   52.54 |    41.25 |   58.33 |   52.67 |                    
  journal.ts      |   52.54 |    41.25 |   58.33 |   52.67 | ...342-352,367-406 
------------------|---------|----------|---------|---------|--------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/services/journal/__tests__/journalServiceNew.test.ts x5 

 ‚úì src/services/journal/__tests__/journalServiceNew.test.ts (3 tests) 8ms

 Test Files  1 passed (1)
      Tests  3 passed (3)
   Start at  18:43:31
   Duration  69ms

 % Coverage report from v8
------------------|---------|----------|---------|---------|--------------------
File              | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s  
------------------|---------|----------|---------|---------|--------------------
All files         |   42.93 |    33.98 |   42.85 |   43.71 |                    
 lib/tests/utils  |   66.66 |      100 |   33.33 |   66.66 |                    
  factories.ts    |   66.66 |      100 |   33.33 |   66.66 | 9,39               
 lib/utils        |   18.86 |     8.69 |   16.66 |    20.4 |                    
  general.ts      |   18.86 |     8.69 |   16.66 |    20.4 | ...-94,119,132-133 
 services/journal |   52.54 |    41.25 |   58.33 |   52.67 |                    
  journal.ts      |   52.54 |    41.25 |   58.33 |   52.67 | ...342-352,367-406 
------------------|---------|----------|---------|---------|--------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/services/journal/__tests__/journalServiceNew.test.ts x6 

 ‚úì src/services/journal/__tests__/journalServiceNew.test.ts (3 tests) 10ms

 Test Files  1 passed (1)
      Tests  3 passed (3)
   Start at  18:43:32
   Duration  89ms

 % Coverage report from v8
------------------|---------|----------|---------|---------|--------------------
File              | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s  
------------------|---------|----------|---------|---------|--------------------
All files         |   42.93 |    33.98 |   42.85 |   43.71 |                    
 lib/tests/utils  |   66.66 |      100 |   33.33 |   66.66 |                    
  factories.ts    |   66.66 |      100 |   33.33 |   66.66 | 9,39               
 lib/utils        |   18.86 |     8.69 |   16.66 |    20.4 |                    
  general.ts      |   18.86 |     8.69 |   16.66 |    20.4 | ...-94,119,132-133 
 services/journal |   52.54 |    41.25 |   58.33 |   52.67 |                    
  journal.ts      |   52.54 |    41.25 |   58.33 |   52.67 | ...342-352,367-406 
------------------|---------|----------|---------|---------|--------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/services/journal/__tests__/journalServiceNew.test.ts x7 

stdout | src/services/journal/__tests__/journalServiceNew.test.ts > Journal Service (New Architecture) > deleteJournalEntry > should delete entry and associated images
Deleting images from storage: [ [32m'img1.webp'[39m ]

 ‚úì src/services/journal/__tests__/journalServiceNew.test.ts (5 tests) 12ms

 Test Files  1 passed (1)
      Tests  5 passed (5)
   Start at  18:43:51
   Duration  95ms

 % Coverage report from v8
------------------|---------|----------|---------|---------|--------------------
File              | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s  
------------------|---------|----------|---------|---------|--------------------
All files         |   50.84 |    41.74 |   52.38 |   51.49 |                    
 lib/tests/utils  |   66.66 |      100 |   33.33 |   66.66 |                    
  factories.ts    |   66.66 |      100 |   33.33 |   66.66 | 9,39               
 lib/utils        |   18.86 |     8.69 |   16.66 |    20.4 |                    
  general.ts      |   18.86 |     8.69 |   16.66 |    20.4 | ...-94,119,132-133 
 services/journal |    64.4 |    51.25 |      75 |   64.28 |                    
  journal.ts      |    64.4 |    51.25 |      75 |   64.28 | ...352,369-372,390 
------------------|---------|----------|---------|---------|--------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/__tests__/hooks/useDashboardData.test.tsx x1 


‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Suites 1 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  src/__tests__/hooks/useDashboardData.test.tsx [ src/__tests__/hooks/useDashboardData.test.tsx ]
Error: No test suite found in file /home/jhontavares/Documents/Programacao/Journal-NextJs/src/__tests__/hooks/useDashboardData.test.tsx
‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ


 Test Files  1 failed (1)
      Tests  no tests
   Start at  18:49:52
   Duration  81ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/__tests__/hooks/useDashboardData.test.tsx x2 

stderr | src/__tests__/hooks/useDashboardData.test.tsx > useDashboardData > should redirect if accountId is invalid format
Account not found after loading: invalid-id

stderr | src/__tests__/hooks/useDashboardData.test.tsx > useDashboardData > should redirect if account is not found
Account not found after loading: 987e4567-e89b-12d3-a456-426614174999

 ‚ùØ src/__tests__/hooks/useDashboardData.test.tsx (7 tests | 1 failed) 1303ms
     ‚úì should redirect if accountId is invalid format 17ms
     √ó should redirect if account is not found 1013ms
     ‚úì should load data successfully for valid account 53ms
     ‚úì should update account balance if calculated PnL differs 55ms
     ‚úì should calculate streak metrics correctly 54ms
     ‚úì should load admin and mentor permissions 55ms
     ‚úì should handle initialization errors 54ms

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Tests 1 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  src/__tests__/hooks/useDashboardData.test.tsx > useDashboardData > should redirect if account is not found
TypeError: [Function error] is not a spy or a call to a spy!

Ignored nodes: comments, script, style
[36m<html>[39m
  [36m<head />[39m
  [36m<body>[39m
    [36m<div />[39m
  [36m</body>[39m
[36m</html>[39m
 ‚ùØ src/__tests__/hooks/useDashboardData.test.tsx:131:35
    129|         await waitFor(() => {
    130|             expect(mockRouter.push).toHaveBeenCalledWith("/");
    131|             expect(console.error).toHaveBeenCalledWith("Account not fo‚Ä¶
       |                                   ^
    132|         });
    133|     });
 ‚ùØ runWithExpensiveErrorDiagnosticsDisabled node_modules/@testing-library/dom/dist/config.js:47:12
 ‚ùØ checkCallback node_modules/@testing-library/dom/dist/wait-for.js:124:77
 ‚ùØ Timeout.checkRealTimersCallback node_modules/@testing-library/dom/dist/wait-for.js:118:16

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ


 Test Files  1 failed (1)
      Tests  1 failed | 6 passed (7)
   Start at  18:49:53
   Duration  1.51s

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/__tests__/hooks/useDashboardData.test.tsx x3 

stderr | src/__tests__/hooks/useDashboardData.test.tsx > useDashboardData > should redirect if accountId is invalid format
Account not found after loading: invalid-id

 ‚úì src/__tests__/hooks/useDashboardData.test.tsx (7 tests) 292ms

 Test Files  1 passed (1)
      Tests  7 passed (7)
   Start at  18:50:30
   Duration  472ms

 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |   15.56 |     7.11 |   16.74 |   15.07 |                   
 components/ui     |    9.09 |        0 |       0 |    9.52 |                   
  Toast.tsx        |    9.09 |        0 |       0 |    9.52 | 34-94             
 hooks             |   94.18 |    76.66 |     100 |   93.58 |                   
  ...hboardData.ts |   94.18 |    76.66 |     100 |   93.58 | ...10,116-117,205 
 lib               |   34.32 |    17.15 |   33.89 |   33.33 |                   
  calculations.ts  |   41.66 |    23.35 |   45.23 |   41.66 | ...63,365,379-390 
  errorHandler.ts  |    3.12 |        0 |       0 |    3.12 | 52-168            
  errorMetrics.ts  |   20.83 |     5.88 |       0 |    23.8 | 20-74             
  errors.ts        |   34.37 |     9.09 |      25 |   32.25 | 33-77             
  storage.ts       |       0 |        0 |       0 |       0 |                   
 lib/logging       |    12.9 |      3.5 |   21.42 |   12.06 |                   
  Logger.ts        |   21.87 |     9.09 |      30 |   20.68 | 15-96             
  safeError.ts     |    3.33 |        0 |       0 |    3.44 | 29-53,100-151     
 lib/repositories  |    3.62 |        0 |    7.69 |    3.87 |                   
  ...Repository.ts |      10 |        0 |    8.33 |      12 | 21-84             
  ...Repository.ts |    1.85 |        0 |    7.14 |    1.92 | 32-445            
 lib/supabase      |     100 |      100 |     100 |     100 |                   
  fragments.ts     |     100 |      100 |     100 |     100 |                   
 lib/utils         |    0.64 |        0 |       0 |    0.67 |                   
  general.ts       |    1.88 |        0 |       0 |    2.04 | 5-34,53-133       
  ...ompression.ts |       0 |        0 |       0 |       0 | 47-381            
 services/admin    |       0 |        0 |       0 |       0 |                   
  migration.ts     |       0 |        0 |       0 |       0 | 18-151            
 services/core     |    4.49 |        0 |       0 |    5.26 |                   
  account.ts       |    4.49 |        0 |       0 |    5.26 | 17-26,125-344     
 services/journal  |    2.66 |        0 |       0 |    2.81 |                   
  journal.ts       |    1.69 |        0 |       0 |    1.78 | 29-32,59-406      
  routine.ts       |    6.25 |        0 |       0 |    6.66 | 66-143            
 ...mentor/invites |       0 |        0 |       0 |       0 |                   
  manage.ts        |       0 |        0 |       0 |       0 | 14-158            
  receive.ts       |       0 |        0 |       0 |       0 | 25-439            
  send.ts          |       0 |        0 |       0 |       0 | 15-102            
  types.ts         |       0 |        0 |       0 |       0 | 39-55             
 services/trades   |    4.76 |        0 |       0 |    5.55 |                   
  mappers.ts       |      50 |        0 |       0 |     100 | 24-84             
  trade.ts         |     2.5 |        0 |       0 |    2.85 | 25-132,180-285    
-------------------|---------|----------|---------|---------|-------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/__tests__/hooks/useJournalForm.test.tsx x1 

 ‚úì src/__tests__/hooks/useJournalForm.test.tsx (6 tests) 23ms

 Test Files  1 passed (1)
      Tests  6 passed (6)
   Start at  18:50:32
   Duration  162ms

 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |     100 |      100 |     100 |     100 |                   
 useJournalForm.ts |     100 |      100 |     100 |     100 |                   
-------------------|---------|----------|---------|---------|-------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/__tests__/hooks/useJournalForm.test.tsx x2 

 ‚úì src/__tests__/hooks/useJournalForm.test.tsx (6 tests) 20ms

 Test Files  1 passed (1)
      Tests  6 passed (6)
   Start at  18:50:33
   Duration  132ms

 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |     100 |      100 |     100 |     100 |                   
 useJournalForm.ts |     100 |      100 |     100 |     100 |                   
-------------------|---------|----------|---------|---------|-------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/__tests__/hooks/useDashboardData.test.tsx x4 

stderr | src/__tests__/hooks/useDashboardData.test.tsx > useDashboardData > should redirect if accountId is invalid format
Account not found after loading: invalid-id

 ‚úì src/__tests__/hooks/useDashboardData.test.tsx (9 tests) 349ms

 Test Files  1 passed (1)
      Tests  9 passed (9)
   Start at  18:51:10
   Duration  556ms

 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |   15.79 |     7.35 |   16.74 |   15.32 |                   
 components/ui     |    9.09 |        0 |       0 |    9.52 |                   
  Toast.tsx        |    9.09 |        0 |       0 |    9.52 | 34-94             
 hooks             |   97.67 |    83.33 |     100 |   97.43 |                   
  ...hboardData.ts |   97.67 |    83.33 |     100 |   97.43 | 109-110           
 lib               |   34.32 |    17.15 |   33.89 |   33.33 |                   
  calculations.ts  |   41.66 |    23.35 |   45.23 |   41.66 | ...63,365,379-390 
  errorHandler.ts  |    3.12 |        0 |       0 |    3.12 | 52-168            
  errorMetrics.ts  |   20.83 |     5.88 |       0 |    23.8 | 20-74             
  errors.ts        |   34.37 |     9.09 |      25 |   32.25 | 33-77             
  storage.ts       |       0 |        0 |       0 |       0 |                   
 lib/logging       |    12.9 |      3.5 |   21.42 |   12.06 |                   
  Logger.ts        |   21.87 |     9.09 |      30 |   20.68 | 15-96             
  safeError.ts     |    3.33 |        0 |       0 |    3.44 | 29-53,100-151     
 lib/repositories  |    3.62 |        0 |    7.69 |    3.87 |                   
  ...Repository.ts |      10 |        0 |    8.33 |      12 | 21-84             
  ...Repository.ts |    1.85 |        0 |    7.14 |    1.92 | 32-445            
 lib/supabase      |     100 |      100 |     100 |     100 |                   
  fragments.ts     |     100 |      100 |     100 |     100 |                   
 lib/utils         |    0.64 |        0 |       0 |    0.67 |                   
  general.ts       |    1.88 |        0 |       0 |    2.04 | 5-34,53-133       
  ...ompression.ts |       0 |        0 |       0 |       0 | 47-381            
 services/admin    |       0 |        0 |       0 |       0 |                   
  migration.ts     |       0 |        0 |       0 |       0 | 18-151            
 services/core     |    4.49 |        0 |       0 |    5.26 |                   
  account.ts       |    4.49 |        0 |       0 |    5.26 | 17-26,125-344     
 services/journal  |    2.66 |        0 |       0 |    2.81 |                   
  journal.ts       |    1.69 |        0 |       0 |    1.78 | 29-32,59-406      
  routine.ts       |    6.25 |        0 |       0 |    6.66 | 66-143            
 ...mentor/invites |       0 |        0 |       0 |       0 |                   
  manage.ts        |       0 |        0 |       0 |       0 | 14-158            
  receive.ts       |       0 |        0 |       0 |       0 | 25-439            
  send.ts          |       0 |        0 |       0 |       0 | 15-102            
  types.ts         |       0 |        0 |       0 |       0 | 39-55             
 services/trades   |    4.76 |        0 |       0 |    5.55 |                   
  mappers.ts       |      50 |        0 |       0 |     100 | 24-84             
  trade.ts         |     2.5 |        0 |       0 |    2.85 | 25-132,180-285    
-------------------|---------|----------|---------|---------|-------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/lib/repositories/__tests__/BaseRepository.test.ts x1 

stderr | src/lib/repositories/__tests__/BaseRepository.test.ts > BaseRepository > getById > should handle not found error
{
  level: [32m'ERROR'[39m,
  context: [32m'test_tableRepository'[39m,
  message: [32m'Query failed'[39m,
  timestamp: [32m'2025-12-19T21:51:12.844Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { code: [32m'PGRST116'[39m, message: [32m'Not found'[39m }
}

stderr | src/lib/repositories/__tests__/BaseRepository.test.ts > BaseRepository > getById > should handle unexpected error
{
  level: [32m'ERROR'[39m,
  context: [32m'test_tableRepository'[39m,
  message: [32m'Unexpected error in repository'[39m,
  timestamp: [32m'2025-12-19T21:51:12.848Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: Error: Network boom
      at [90m/home/jhontavares/Documents/Programacao/Journal-NextJs/[39msrc/lib/repositories/__tests__/BaseRepository.test.ts:63:51
      at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
      at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
      at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
      at new Promise (<anonymous>)
      at runWithTimeout [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
      at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
      at Traces.$ [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
      at trace [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
      at runTest [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m
}

stderr | src/lib/repositories/__tests__/BaseRepository.test.ts > BaseRepository > delete > should return error on delete failure
{
  level: [32m'ERROR'[39m,
  context: [32m'test_tableRepository'[39m,
  message: [32m'Query failed'[39m,
  timestamp: [32m'2025-12-19T21:51:12.860Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Failed'[39m }
}

 ‚ùØ src/lib/repositories/__tests__/BaseRepository.test.ts (8 tests | 1 failed) 22ms
       ‚úì should return data on success 3ms
       ‚úì should handle not found error 4ms
       √ó should handle unexpected error 11ms
       ‚úì should insert and return data 1ms
       ‚úì should update and return data 0ms
       ‚úì should delete and return true 0ms
       ‚úì should return error on delete failure 1ms
       ‚úì should query with 'in' operator 1ms

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Tests 1 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  src/lib/repositories/__tests__/BaseRepository.test.ts > BaseRepository > getById > should handle unexpected error
AssertionError: expected 'Network boom' to contain 'Unexpected repository error'

Expected: [32m"Unexpected repository error"[39m
Received: [31m"Network boom"[39m

 ‚ùØ src/lib/repositories/__tests__/BaseRepository.test.ts:71:43
     69|             expect(result.data).toBeNull();
     70|             expect(result.error).not.toBeNull();
     71|             expect(result.error?.message).toContain("Unexpected reposi‚Ä¶
       |                                           ^
     72|         });
     73|     });

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ


 Test Files  1 failed (1)
      Tests  1 failed | 7 passed (8)
   Start at  18:51:12
   Duration  97ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/lib/repositories/__tests__/BaseRepository.test.ts x2 

stderr | src/lib/repositories/__tests__/BaseRepository.test.ts > BaseRepository > getById > should handle not found error
{
  level: [32m'ERROR'[39m,
  context: [32m'test_tableRepository'[39m,
  message: [32m'Query failed'[39m,
  timestamp: [32m'2025-12-19T21:51:24.287Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { code: [32m'PGRST116'[39m, message: [32m'Not found'[39m }
}

stderr | src/lib/repositories/__tests__/BaseRepository.test.ts > BaseRepository > getById > should handle unexpected error
{
  level: [32m'ERROR'[39m,
  context: [32m'test_tableRepository'[39m,
  message: [32m'Unexpected error in repository'[39m,
  timestamp: [32m'2025-12-19T21:51:24.291Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: Error: Network boom
      at [90m/home/jhontavares/Documents/Programacao/Journal-NextJs/[39msrc/lib/repositories/__tests__/BaseRepository.test.ts:63:51
      at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
      at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
      at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
      at new Promise (<anonymous>)
      at runWithTimeout [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
      at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
      at Traces.$ [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
      at trace [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
      at runTest [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m
}

stderr | src/lib/repositories/__tests__/BaseRepository.test.ts > BaseRepository > delete > should return error on delete failure
{
  level: [32m'ERROR'[39m,
  context: [32m'test_tableRepository'[39m,
  message: [32m'Query failed'[39m,
  timestamp: [32m'2025-12-19T21:51:24.299Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Failed'[39m }
}

 ‚ùØ src/lib/repositories/__tests__/BaseRepository.test.ts (8 tests | 1 failed) 17ms
       ‚úì should return data on success 3ms
       ‚úì should handle not found error 3ms
       √ó should handle unexpected error 7ms
       ‚úì should insert and return data 1ms
       ‚úì should update and return data 0ms
       ‚úì should delete and return true 0ms
       ‚úì should return error on delete failure 0ms
       ‚úì should query with 'in' operator 1ms

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Tests 1 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  src/lib/repositories/__tests__/BaseRepository.test.ts > BaseRepository > getById > should handle unexpected error
AssertionError: expected undefined to be defined
 ‚ùØ src/lib/repositories/__tests__/BaseRepository.test.ts:74:49
     72|             expect(result.error?.message).toBeDefined();
     73|             // Just check it exists and has some content related to er‚Ä¶
     74|             expect(result.error?.originalError).toBeDefined();
       |                                                 ^
     75|         });
     76|     });

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ


 Test Files  1 failed (1)
      Tests  1 failed | 7 passed (8)
   Start at  18:51:23
   Duration  72ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/lib/repositories/__tests__/BaseRepository.test.ts x3 

stderr | src/lib/repositories/__tests__/BaseRepository.test.ts > BaseRepository > getById > should handle not found error
{
  level: [32m'ERROR'[39m,
  context: [32m'test_tableRepository'[39m,
  message: [32m'Query failed'[39m,
  timestamp: [32m'2025-12-19T21:51:38.007Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { code: [32m'PGRST116'[39m, message: [32m'Not found'[39m }
}

stderr | src/lib/repositories/__tests__/BaseRepository.test.ts > BaseRepository > getById > should handle unexpected error
{
  level: [32m'ERROR'[39m,
  context: [32m'test_tableRepository'[39m,
  message: [32m'Unexpected error in repository'[39m,
  timestamp: [32m'2025-12-19T21:51:38.011Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: Error: Network boom
      at [90m/home/jhontavares/Documents/Programacao/Journal-NextJs/[39msrc/lib/repositories/__tests__/BaseRepository.test.ts:63:51
      at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
      at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
      at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
      at new Promise (<anonymous>)
      at runWithTimeout [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
      at [90mfile:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
      at Traces.$ [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
      at trace [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
      at runTest [90m(file:///home/jhontavares/Documents/Programacao/Journal-NextJs/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m
}

stderr | src/lib/repositories/__tests__/BaseRepository.test.ts > BaseRepository > delete > should return error on delete failure
{
  level: [32m'ERROR'[39m,
  context: [32m'test_tableRepository'[39m,
  message: [32m'Query failed'[39m,
  timestamp: [32m'2025-12-19T21:51:38.019Z'[39m,
  userAgent: [32m'Mozilla/5.0 (linux) AppleWebKit/537.36 (KHTML, like Gecko) jsdom/27.3.0'[39m,
  error: { message: [32m'Failed'[39m }
}

 ‚úì src/lib/repositories/__tests__/BaseRepository.test.ts (8 tests) 17ms

 Test Files  1 passed (1)
      Tests  8 passed (8)
   Start at  18:51:37
   Duration  73ms

 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |    50.8 |    26.37 |   66.66 |      50 |                   
 lib               |   59.37 |    31.81 |      75 |   58.06 |                   
  errors.ts        |   59.37 |    31.81 |      75 |   58.06 | 42-58,66,73-77    
 lib/logging       |   24.19 |    12.28 |   35.71 |   24.13 |                   
  Logger.ts        |   43.75 |    31.81 |      50 |   44.82 | 17,48-56,68-96    
  safeError.ts     |    3.33 |        0 |       0 |    3.44 | 29-53,100-151     
 lib/repositories  |   96.66 |    83.33 |     100 |     100 |                   
  ...Repository.ts |   96.66 |    83.33 |     100 |     100 | 29-33             
-------------------|---------|----------|---------|---------|-------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/__tests__/components/journal/form/JournalEntryForm.test.tsx x1 

 ‚ùØ src/__tests__/components/journal/form/JournalEntryForm.test.tsx (4 tests | 1 failed) 53ms
     ‚úì renders correctly 30ms
     ‚úì updates state correctly through sub-components (EntryHeader) 8ms
     √ó opens link trade modal 5ms
     ‚úì submits the form 8ms

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ Failed Tests 1 ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ

 FAIL  src/__tests__/components/journal/form/JournalEntryForm.test.tsx > JournalEntryForm > opens link trade modal
ReferenceError: act is not defined
 ‚ùØ src/__tests__/components/journal/form/JournalEntryForm.test.tsx:121:5
    119|     expect(screen.queryByTestId("link-trade-modal")).not.toBeInTheDocu‚Ä¶
    120| 
    121|     act(() => {
       |     ^
    122|         fireEvent.click(screen.getByTestId("open-link-modal-btn"));
    123|     });

‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/1]‚éØ


 Test Files  1 failed (1)
      Tests  1 failed | 3 passed (4)
   Start at  18:52:25
   Duration  217ms

 FAIL  Tests failed. Watching for file changes...
       press h to show help, press q to quit
c[3J RERUN  src/__tests__/components/journal/form/JournalEntryForm.test.tsx x2 

stderr | src/__tests__/components/journal/form/JournalEntryForm.test.tsx > JournalEntryForm > opens link trade modal
An update to JournalEntryForm inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://react.dev/link/wrap-tests-with-act

 ‚úì src/__tests__/components/journal/form/JournalEntryForm.test.tsx (4 tests) 69ms

 Test Files  1 passed (1)
      Tests  4 passed (4)
   Start at  18:52:42
   Duration  230ms

 % Coverage report from v8
-------------------|---------|----------|---------|---------|-------------------
File               | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s 
-------------------|---------|----------|---------|---------|-------------------
All files          |   71.79 |    74.35 |   33.33 |   77.77 |                   
 ...lEntryForm.tsx |   71.79 |    74.35 |   33.33 |   77.77 | ...23-130,134,207 
-------------------|---------|----------|---------|---------|-------------------
 PASS  Waiting for file changes...
       press h to show help, press q to quit

Restarting due to config changes...
Loaded  vitest@4.0.16  and  @vitest/coverage-v8@4.0.15 .
Running mixed versions is not supported and may lead into bugs
Update your dependencies and make sure the versions match.

 DEV  v4.0.16 /home/jhontavares/Documents/Programacao/Journal-NextJs
      Coverage enabled with v8

stdout | src/lib/__tests__/production-smoke.test.ts
[dotenv@17.2.3] injecting env (6) from .env.local -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

stdout | src/lib/__tests__/production-smoke.test.ts > Production Performance Tests
‚úÖ Supabase client initialized for production tests

stderr | src/__tests__/hooks/useDashboardData.test.tsx > useDashboardData > should redirect if accountId is invalid format
Account not found after loading: invalid-id

stderr | src/__tests__/components/ui/VisualComponents.test.tsx > UI Components Part 2 > AssetIcon > should render single icon for non-pair
Received `true` for a non-boolean attribute `fill`.

If you want to write it to the DOM, pass a string instead: fill="true" or fill={value.toString()}.
Received `true` for a non-boolean attribute `unoptimized`.

If you want to write it to the DOM, pass a string instead: unoptimized="true" or unoptimized={value.toString()}.

 ‚úì src/__tests__/hooks/HooksAndUtils.test.tsx (7 tests) 301ms
node:internal/fs/promises:639
  return new FileHandle(await PromisePrototypeThen(
                        ^

Error: ENOENT: no such file or directory, open '/home/jhontavares/Documents/Programacao/Journal-NextJs/coverage/.tmp/coverage-80.json'
    at open (node:internal/fs/promises:639:25)
    at Object.writeFile (node:internal/fs/promises:1216:14) {
  errno: -2,
  code: 'ENOENT',
  syscall: 'open',
  path: '/home/jhontavares/Documents/Programacao/Journal-NextJs/coverage/.tmp/coverage-80.json'
}

Node.js v20.19.6
